package com.sky.system.stock.isos.goodsosttlist;


import net.sky.http.dispatch.control.DefaultServiceHandler;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.sky.data.DataMessage;
import com.sky.data.SqlResultMap;
import com.sky.http.HttpRequestArgument;
import com.sky.listener.SeqListenerService;


@Service
public class GoodsOsttListService extends DefaultServiceHandler {

	@Autowired
	SeqListenerService sequence ;

	public SqlResultMap getMaster1(HttpRequestArgument arg, int page, int rows, String sort) throws Exception {

		DataMessage data = arg.newStorage("POS");
		data.param
			.query("select  *																												")
		;
		data.param
			.where("from (																													")
			.where("    with cte as ( 																										")
			.where("       select a.* 																										")
			.where("       from (																											")
			.where("             select a.invc_numb               , b.invc_date               , b.ostt_dvcd        , b.expt_dvcd			")
			.where("                  , b.trut_dvcd               , b.dlvy_cond_dvcd          , b.deli_date        , b.sale_stor_yorn		")
			.where("                  , c.cstm_name               , u.user_name as drtr_name  , u2.user_name as acpt_drtr_name				")
			.where("                  , a.acpt_numb               , a.item_idcd               , c.cstm_idcd        , c.cstm_code			")
			.where("                  , a.sale_unit               , a.norm_sale_pric          , a.sale_stnd_pric   , a.sale_pric			")
			.where("                  , a.ostt_qntt               , a.vatx_incl_yorn          , a.vatx_rate        , a.sale_amnt			")
			.where("                  , a.vatx_amnt               , a.ttsm_amnt               , a.dlvy_date									")
			.where("                  , a.dlvy_hhmm               , a.stnd_unit               , a.stnd_unit_qntt   , a.wrhs_idcd			")
			.where("                  , a.dlvy_cstm_idcd          , a.dsct_yorn               , a.insp_dvcd									")
			.where("                  , a.insp_date               , a.pcod_numb               , a.sale_date        , a.sale_invc_numb		")
			.where("                  , a.sysm_memo               , a.prnt_idcd               , a.line_levl									")
			.where("                  , a.line_ordr               , a.line_stat               , a.line_clos        , i.find_name			")
			.where("                  , a.updt_user_name          , a.updt_ipad               , a.updt_dttm        , a.updt_idcd			")
			.where("                  , a.updt_urif               , a.crte_user_name          , a.crte_ipad        , a.crte_dttm			")
			.where("                  , a.crte_idcd               , a.crte_urif               , a.lott_numb        , i.item_code			")
			.where("                  , i.item_name               , i.item_spec               , i.modl_name        , w.wrhs_name			")
			.where("                  , a.orig_invc_numb          , a.orig_seqn               , a.acpt_seqn		  , a.line_seqn				")
			.where("                  , c1.clss_name as lcls_name , c2.clss_name as mcls_name , c3.clss_name as scls_name					")
			.where("                  , null as rett_date         , null as rett_qntt         , null as rett_yorn							")
			.where("                  , null as rett_resn_dvcd    , null as rett_proc_dvcd													")
			.where("                  , m.acpt_dvcd               , json_value(m.json_data, '$.prod_trst_dvcd') as prod_trst_dvcd			")
		;
		// 삼정(향료)인 경우 상품이면 매입단다/매입금액/마진울을  원료이면 사용된 제품명을 비고컬럼에 표시한다.
		if(arg.getParamText("mes_system_type").toUpperCase().equals("SJFLV")){
		    data.param
			    .where("                  , case when i.acct_bacd = '4000' then																	")
				.where("                              (select pi.istt_pric																		")
				.where("                                 from purc_istt_mast pm																	")
				.where("                                      left outer join purc_istt_item pi on pi.invc_numb = pm.invc_numb					")
				.where("                                where pi.item_idcd = a.item_idcd and pi.lott_numb = a.lott_numb and pm.line_stat < 2	")
				.where("                                order by pm.invc_date limit 1)															")
				.where("                         else null																						")
				.where("                    end istt_pric																						")
				.where("                  , case when i.acct_bacd = '4000' then																	")
				.where("                              (select pi.istt_amnt																		")
				.where("                                 from purc_istt_mast pm																	")
				.where("                                      left outer join purc_istt_item pi on pi.invc_numb = pm.invc_numb					")
				.where("                                where pi.item_idcd = a.item_idcd and pi.lott_numb = a.lott_numb and pm.line_stat < 2	")
				.where("                                order by pm.invc_date limit 1)															")
				.where("                         else null																						")
				.where("                    end istt_amnt																						")
				.where("                  , case when i.acct_bacd = '4000' then																	")
				.where("                              (select concat(round(((a.sale_pric - pi.istt_pric) / a.sale_pric) * 100, 0), '%')			")
				.where("                                 from purc_istt_mast pm																	")
				.where("                                      left outer join purc_istt_item pi on pi.invc_numb = pm.invc_numb					")
				.where("                                where pi.item_idcd = a.item_idcd and pi.lott_numb = a.lott_numb and pm.line_stat < 2	")
				.where("                                order by pm.invc_date limit 1)															")
				.where("                         else null																						")
				.where("                    end pfit_rate																						")
				.where("                  , case when i.acct_bacd = '1001' then 																")
				.where("                             (select concat('제품명 : ', im.item_name)													")
				.where("                                from acpt_item ai		 																")
				.where("                                     left outer join item_mast im on im.item_idcd = ai.item_idcd						")
				.where("                               where 1 = 1																				")
				.where("                                 and ai.invc_numb = a.acpt_numb															")
				.where("                                 and ai.line_seqn = a.acpt_seqn)														")
				.where("                         else a.user_memo																				")
				.where("                    end user_memo	, 1 as trns_type																	")
			;
		} else {
			data.param
				.where("                  , null as istt_pric																					")
				.where("                  , null as istt_amnt																					")
				.where("                  , null as pfit_rate																					")
				.where("                  , a.user_memo	, 1 as trns_type																		")
			;
		}
		data.param
			.where("             from   sale_ostt_item a																					")
			.where("                    left outer join sale_ostt_mast b on a.invc_numb = b.invc_numb										")
			.where("                    left outer join acpt_mast m on m.invc_numb = a.acpt_numb											")
			.where("                    left outer join cstm_mast c on b.cstm_idcd = c.cstm_idcd											")
			.where("                    left outer join item_mast i on a.item_idcd = i.item_idcd											")
			.where("                    left outer join item_clss c1 on i.lcls_idcd = c1.clss_idcd											")
			.where("                    left outer join item_clss c2 on i.mcls_idcd = c2.clss_idcd											")
			.where("                    left outer join item_clss c3 on i.scls_idcd = c3.clss_idcd											")
			.where("                    left outer join wrhs_mast w on a.wrhs_idcd = w.wrhs_idcd											")
		;
		if(arg.getParamText("mes_system_type").toUpperCase().equals("SJFLV")){
		    data.param
				.where("                left outer join user_mast u on b.drtr_idcd = u.lgin_idcd											")
				.where("                left outer join user_mast u2 on m.drtr_idcd = u2.user_idcd											")
			;
		}else{
		    data.param
				.where("                left outer join user_mast u on b.drtr_idcd = u.user_idcd											")
			;
		}
		data.param
			.where("             where  1 = 1																								")
			.where("             and   json_value(a.json_data, '$.trns_date') is null																")
			.where("             and    i.find_name like %:find_name%    " , arg.getParamText("find_name"  ))
			.where("             and    a.item_idcd  = :item_idcd       "  , arg.getParamText("item_idcd"  ))
			.where("             and    b.invc_date >= :invc_date1       " , arg.getParamText("invc_date1" ))
			.where("             and    b.invc_date <= :invc_date2       " , arg.getParamText("invc_date2" ))
			.where("             and    a.deli_date >= :deli_date1       " , arg.getParamText("deli_date1" ))
			.where("             and    a.deli_date <= :deli_date2       " , arg.getParamText("deli_date2" ))
			.where("             and    a.acpt_numb  = :invc_numb        " , arg.getParamText("invc_numb" ))
			.where("             and    b.cstm_idcd  = :cstm_idcd        " , arg.getParamText("cstm_idcd" ))
			.where("             and    a.wrhs_idcd  = :wrhs_idcd        " , arg.getParamText("wrhs_idcd" ))
			.where("             and    m.acpt_dvcd  = :acpt_dvcd        " , arg.getParamText("acpt_dvcd" ))
			.where("             and    b.line_stat  = :line_stat        " , arg.getParamText("line_stat" ) , !"".equals(arg.getParamText("line_stat" )))
		;
		// 삼정인 경우 삼정수주 - 주문생산, 재고주문, OEM수주 - 주문생산, 재고생산 이렇게 표시된다.
		if(arg.getParamText("mes_system_type").toUpperCase().equals("SJFLV")){
			data.param
				.where("             and    ((m.acpt_dvcd = '1000' and json_value(m.json_data, '$.prod_trst_dvcd') <> '2000') or (m.acpt_dvcd = '2000' and json_value(m.json_data, '$.prod_trst_dvcd') <> '3000')) ")
			;
		}

		// 이월
			data.param
				.where("             union all																												")
				.where("             select a.invc_numb                  , b.invc_date                  , b.ostt_dvcd              , null as expt_dvcd		")
				.where("                  , null as trut_dvcd            , null as dlvy_cond_dvcd       , json_value(a.json_data, '$.trns_date') as deli_date")
				.where("                  , null as sale_stor_yorn       , c.cstm_name                  , u.user_name as drtr_name , u2.user_name as acpt_drtr_name	")
				.where("                  , a.acpt_numb                  , a.item_idcd                  , c.cstm_idcd              , c.cstm_code			")
				.where("                  , null as sale_unit            , a.norm_sale_pric             , a.sale_stnd_pric         , a.sale_pric			")
				.where("                  , a.ostt_qntt                  , a.vatx_incl_yorn             , a.vatx_rate              							")
				.where("                  , a.sale_amnt																										")
				.where("                  , a.vatx_amnt 																									")
				.where("                  , a. ttsm_amnt 																									")
				.where("                  , null as dlvy_date																								")
				.where("                  , null as dlvy_hhmm            , null as stnd_unit             , null as stnd_unit_qntt   , a.wrhs_idcd			")
				.where("                  , null as dlvy_cstm_idcd       , null as dsct_yorn             , null as insp_dvcd								")
				.where("                  , null as insp_date            , null as pcod_numb             , null as sale_date        , null as sale_invc_numb")
				.where("                  , a.sysm_memo                  , a.prnt_idcd                   , a.line_levl										")
				.where("                  , a.line_ordr                  , a.line_stat                   , a.line_clos              , i.find_name			")
				.where("                  , a.updt_user_name             , a.updt_ipad                   , a.updt_dttm              , a.updt_idcd			")
				.where("                  , a.updt_urif                  , a.crte_user_name              , a.crte_ipad              , a.crte_dttm			")
				.where("                  , a.crte_idcd                  , a.crte_urif                   , a.lott_numb              , i.item_code			")
				.where("                  , i.item_name                  , i.item_spec                   , i.modl_name              , w.wrhs_name			")
				.where("                  , a.orig_invc_numb             , a.orig_seqn                   , a.acpt_seqn		        , a.line_seqn			")
				.where("                  , c1.clss_name as lcls_name    , c2.clss_name as mcls_name     , c3.clss_name as scls_name						")
				.where("                  , null as rett_date            , null as rett_qntt             , null as rett_yorn								")
				.where("                  , null as rett_resn_dvcd       , null as rett_proc_dvcd															")
				.where("                  , m.acpt_dvcd                  , json_value(m.json_data, '$.prod_trst_dvcd') as prod_trst_dvcd					")
				.where("                  , case when i.acct_bacd = '4000' then																				")
				.where("                              (select pi.istt_pric																					")
				.where("                                 from purc_istt_mast pm																				")
				.where("                                      left outer join purc_istt_item pi on pi.invc_numb = pm.invc_numb								")
				.where("                                where pi.item_idcd = a.item_idcd and pi.lott_numb = a.lott_numb and pm.line_stat < 2				")
				.where("                                order by pm.invc_date limit 1)																		")
				.where("                         else null																									")
				.where("                    end istt_pric																									")
				.where("                  , case when i.acct_bacd = '4000' then																				")
				.where("                              (select pi.istt_amnt																					")
				.where("                                 from purc_istt_mast pm																				")
				.where("                                      left outer join purc_istt_item pi on pi.invc_numb = pm.invc_numb								")
				.where("                                where pi.item_idcd = a.item_idcd and pi.lott_numb = a.lott_numb and pm.line_stat < 2				")
				.where("                                order by pm.invc_date limit 1)																		")
				.where("                         else null																									")
				.where("                    end istt_amnt																									")
				.where("                  , case when i.acct_bacd = '4000' then																				")
				.where("                              (select concat(round(((a.sale_pric - pi.istt_pric) / a.sale_pric) * 100, 0), '%')						")
				.where("                                 from purc_istt_mast pm																				")
				.where("                                      left outer join purc_istt_item pi on pi.invc_numb = pm.invc_numb								")
				.where("                                where pi.item_idcd = a.item_idcd and pi.lott_numb = a.lott_numb and pm.line_stat < 2				")
				.where("                                order by pm.invc_date limit 1)																		")
				.where("                         else null																									")
				.where("                    end pfit_rate																									")
				.where("                  , a.user_memo                  , 2 as 	trns_type																")
			;
			data.param
				.where("             from   sale_ostt_item a																							")
				.where("                    left outer join sale_ostt_mast b on b.invc_numb = a.invc_numb												")
				.where("                    left outer join acpt_mast m  on m.invc_numb = a.acpt_numb													")
				.where("                    left outer join cstm_mast c  on c.cstm_idcd = b.cstm_idcd													")
				.where("                    left outer join item_mast i  on i.item_idcd = a.item_idcd													")
				.where("                    left outer join item_clss c1 on c1.clss_idcd = i.lcls_idcd			 										")
				.where("                    left outer join item_clss c2 on c2.clss_idcd = i.mcls_idcd			 										")
				.where("                    left outer join item_clss c3 on c3.clss_idcd = i.scls_idcd			 										")
				.where("                    left outer join user_mast u  on u.user_idcd = b.drtr_idcd													")
				.where("                    left outer join user_mast u2 on m.drtr_idcd = u2.user_idcd													")
				.where("                    left outer join wrhs_mast w  on w.wrhs_idcd = a.wrhs_idcd													")
				.where("             where  1 = 1																										")
				.where("             and    i.find_name like %:find_name1%   " , arg.getParamText("find_name"  ))
				.where("             and    a.item_idcd  = :item_idcd2       " , arg.getParamText("item_idcd"  ))
				.where("             and    b.invc_date >= :invc_date5       " , arg.getParamText("invc_date1" ))
				.where("             and    b.invc_date <= :invc_date6       " , arg.getParamText("invc_date2" ))
				.where("             and    json_value(a.json_data, '$.trns_date') >= :deli_date21       " , arg.getParamText("deli_date1" ))
				.where("             and    json_value(a.json_data, '$.trns_date') <= :deli_date22       " , arg.getParamText("deli_date2" ))
				.where("             and    a.acpt_numb  = :invc_numb2       " , arg.getParamText("invc_numb" ))
				.where("             and    b.cstm_idcd  = :cstm_idcd2       " , arg.getParamText("cstm_idcd" ))
				.where("             and    a.wrhs_idcd  = :wrhs_idcd2       " , arg.getParamText("wrhs_idcd" ))
				.where("             and    m.acpt_dvcd  = :acpt_dvcd2       " , arg.getParamText("acpt_dvcd" ))
				.where("             and    b.line_stat  = :line_stat2       " , arg.getParamText("line_stat" ) , !"".equals(arg.getParamText("line_stat" )))
				.where("             and    json_value(a.json_data, '$.trns_date') is not null										")
				.where("             and    ((m.acpt_dvcd = '1000' and json_value(m.json_data, '$.prod_trst_dvcd') <> '2000') or (m.acpt_dvcd = '2000' and json_value(m.json_data, '$.prod_trst_dvcd') <> '3000')) ")
			;

		// 작업중 시작
		data.param
			.where("             union all								")
			.where("             select a.invc_numb                  , null as invc_date            , b.ostt_dvcd              , null as expt_dvcd		")
			.where("                  , null as trut_dvcd            , null as dlvy_cond_dvcd       , b.invc_date as deli_date , null as sale_stor_yorn	")
			.where("                  , c.cstm_name                  , u.user_name as drtr_name		, u2.user_name as acpt_drtr_name					")
			.where("                  , a.acpt_numb                  , a.item_idcd                  , c.cstm_idcd              , c.cstm_code			")
			.where("                  , null as sale_unit            , a.norm_sale_pric             , a.sale_stnd_pric         , a.sale_pric			")
			.where("                  , a.rett_qntt * -1  as ostt_qntt  , a.vatx_incl_yorn          , a.vatx_rate * -1	as vatx_rate 					")
			.where("                  , a.sply_amnt * -1  as sale_amnt																					")
			.where("                  , a.vatx_amnt * -1  as vatx_amnt																					")
			.where("                  , a.ttsm_amnt * -1  as ttsm_amnt																					")
			.where("                  , null as dlvy_date																								")
			.where("                  , null as dlvy_hhmm            , null as stnd_unit             , null as stnd_unit_qntt   , a.wrhs_idcd			")
			.where("                  , null as dlvy_cstm_idcd       , null as dsct_yorn             , null as insp_dvcd								")
			.where("                  , null as insp_date            , null as pcod_numb             , null as sale_date        , null as sale_invc_numb")
			.where("                  , a.sysm_memo                  , a.prnt_idcd                   , a.line_levl										")
			.where("                  , a.line_ordr                  , a.line_stat                   , a.line_clos              , i.find_name			")
			.where("                  , a.updt_user_name             , a.updt_ipad                   , a.updt_dttm              , a.updt_idcd			")
			.where("                  , a.updt_urif                  , a.crte_user_name              , a.crte_ipad              , a.crte_dttm			")
			.where("                  , a.crte_idcd                  , a.crte_urif                   , a.lott_numb              , i.item_code			")
			.where("                  , i.item_name                  , i.item_spec                   , i.modl_name              , w.wrhs_name			")
			.where("                  , a.orig_invc_numb             , a.orig_seqn                   , a.acpt_seqn		        , a.line_seqn			")
			.where("                  , c1.clss_name as lcls_name    , c2.clss_name as mcls_name     , c3.clss_name as scls_name						")
			.where("                  , b.invc_date as rett_date     , a.rett_qntt * -1 as rett_qntt , '1' as rett_yorn									")
			.where("                  , a.rett_resn_dvcd             , a.rett_proc_dvcd																	")
			.where("                  , m.acpt_dvcd                  , json_value(m.json_data, '$.prod_trst_dvcd') as prod_trst_dvcd					")
			.where("                  , null as istt_pric            , null as istt_amnt             , null as pfit_rate								")


		;
		// 삼정(향료)인 경우 반품폐기 된 경우 폐기일자를 비고에 표시한다.
		if(arg.getParamText("mes_system_type").toUpperCase().equals("SJFLV")){
			data.param
				.where("                  , case when a.rett_proc_dvcd = '5000' then concat('폐기일자:', date_format(a.proc_dttm, '%Y-%m-%d'), ' ', a.user_memo)	")
				.where("                         else a.user_memo																								")
				.where("                    end user_memo , 3 as 	trns_type																										")
			;
		} else {
			data.param
				.where("                  , a.user_memo  , 3 as 	trns_type																											")
			;
		}
		data.param
			.where("             from   sale_rett_item a																							")
			.where("                    left outer join sale_rett_mast b on b.invc_numb = a.invc_numb												")
			.where("                    left outer join acpt_mast m  on m.invc_numb = a.acpt_numb													")
			.where("                    left outer join cstm_mast c  on c.cstm_idcd = b.cstm_idcd													")
			.where("                    left outer join item_mast i  on i.item_idcd = a.item_idcd													")
			.where("                    left outer join item_clss c1 on c1.clss_idcd = i.lcls_idcd			 										")
			.where("                    left outer join item_clss c2 on c2.clss_idcd = i.mcls_idcd			 										")
			.where("                    left outer join item_clss c3 on c3.clss_idcd = i.scls_idcd			 										")
			.where("                    left outer join user_mast u  on u.user_idcd = b.drtr_idcd													")
			.where("                    left outer join user_mast u2 on m.drtr_idcd = u2.user_idcd													")
			.where("                    left outer join wrhs_mast w  on w.wrhs_idcd = a.wrhs_idcd													")
			.where("             where  1 = 1																										")
			.where("             and    i.find_name like %:find_name2%   " , arg.getParamText("find_name"  ))
//			.where("             and    m.acpt_dvcd = '1000'																						")
			.where("             and    a.item_idcd  = :item_idcd1       " , arg.getParamText("item_idcd"  ))
			.where("             and    b.invc_date >= :invc_date3       " , arg.getParamText("invc_date1" ))
			.where("             and    b.invc_date <= :invc_date4       " , arg.getParamText("invc_date2" ))
			.where("             and    b.invc_date >= :deli_date3       " , arg.getParamText("deli_date1" ))
			.where("             and    b.invc_date <= :deli_date4       " , arg.getParamText("deli_date2" ))
			.where("             and    a.acpt_numb  = :invc_numb1       " , arg.getParamText("invc_numb" ))
			.where("             and    b.cstm_idcd  = :cstm_idcd1       " , arg.getParamText("cstm_idcd" ))
			.where("             and    a.wrhs_idcd  = :wrhs_idcd1       " , arg.getParamText("wrhs_idcd" ))
			.where("             and    m.acpt_dvcd  = :acpt_dvcd1       " , arg.getParamText("acpt_dvcd" ))
			.where("             and    b.line_stat  = :line_stat1       " , arg.getParamText("line_stat" ) , !"".equals(arg.getParamText("line_stat" )))
		;

		// 삼정(향료)인 경우 삼정수주 - 주문생산, 재고주문, OEM수주 - 주문생산, 재고생산 이렇게 표시된다.
		if(arg.getParamText("mes_system_type").toUpperCase().equals("SJFLV")){
			data.param
				.where("             and    ((json_value(m.json_data, '$.prod_trst_dvcd') <> '2000') or (m.acpt_dvcd = '2000' and json_value(m.json_data, '$.prod_trst_dvcd') <> '3000')) ")
			;
		}
		// 작업중 종료


		data.param
			.where("            ) a																		")
			.where("       order  by a.deli_date desc, a.invc_numb desc, a.line_seqn					")
			.where("    ) 																				")
		;
		data.param
			.where(" select  a.line_stat																")
			.where("       , a.invc_numb																")
			.where("       , a.line_seqn																")
			.where("       , a.cstm_idcd																")
			.where("       , a.cstm_code																")
			.where("       , a.cstm_name																")
			.where("       , a.deli_date																")
			.where("       , a.invc_date																")
			.where("       , a.rett_date																")
			.where("       , a.drtr_name																")
			.where("       , a.acpt_drtr_name															")
			.where("       , a.item_idcd																")
			.where("       , a.item_code																")
			.where("       , a.item_name																")
			.where("       , a.item_spec																")
			.where("       , a.lott_numb																")
			.where("       , a.wrhs_name																")
			.where("       , a.ostt_qntt																")
			.where("       , a.rett_qntt																")
			.where("       , a.sale_pric																")
			.where("       , a.sale_amnt																")
			.where("       , a.vatx_amnt																")
			.where("       , a.ttsm_amnt																")
			.where("       , a.acpt_numb																")
			.where("       , a.acpt_dvcd																")
			.where("       , a.prod_trst_dvcd															")
			.where("       , a.user_memo																")
//			.where("       , a.deli_date as crt_date													")
			.where("       , case when a.acpt_dvcd = '1000' then deli_date								")
			.where("              when a.acpt_dvcd = '2000' then invc_date								")
			.where("              else deli_date														")
			.where("              end as crt_date														")
			.where("       , a.find_name																")
			.where("       , a.rett_resn_dvcd															")
			.where("       , a.rett_proc_dvcd															")
			.where("       , a.rett_yorn																")
			.where("       , 1 as rnum																	")
			.where("       , a.wrhs_idcd																")
			.where("       , a.lcls_name																")
			.where("       , a.mcls_name																")
			.where("       , a.scls_name																")
			.where("       , a.istt_pric																")
			.where("       , a.pfit_rate																")
			.where("       , a.istt_amnt																")
			.where("       , a.trns_type																")
			.where(" from cte a																			")
		;
/*
			.where(" union all																			")
			.where(" select  ra.line_stat																")
			.where("       , ra.invc_numb																")
			.where("       , null as line_seqn															")
			.where("       , ra.cstm_idcd																")
			.where("       , cm.cstm_code																")
			.where("       , cm.cstm_name																")
			.where("       , m.deli_date																")
			.where("       , m.invc_date																")
			.where("       , ra.invc_date as invc_date2													")
			.where("       , um.user_name as drtr_name													")
			.where("       , s.item_idcd																")
			.where("       , im.item_code																")
			.where("       , im.item_name																")
			.where("       , im.item_spec																")
			.where("       , s.lott_numb																")
			.where("       , wh.wrhs_name																")
			.where("       , io.ostt_qntt																")
			.where("       , s.rett_qntt * -1															")
			.where("       , s.sale_pric 																")
			.where("       , (s.rett_qntt * s.sale_pric) * -1 as sale_amnt								")
			.where("       , ((s.rett_qntt * s.sale_pric) * 0.1 * -1) as vatx_amnt						")
			.where("       , (((s.rett_qntt * s.sale_pric)+((s.rett_qntt * s.sale_pric) * 0.1))*-1) as ttsm_amnt	")
			.where("       , s.acpt_numb																")
			.where("       , ac.acpt_dvcd																")
			.where("       , ((ac.acpt_dvcd = '1000' and json_value(ac.json_data, '$.prod_trst_dvcd') <> '2000') or (ac.acpt_dvcd = '2000' and json_value(ac.json_data, '$.prod_trst_dvcd') <> '3000'))	")

			.where("       , case when s.rett_proc_dvcd = '5000' then concat('폐기일자:', date_format(s.proc_dttm, '%Y-%m-%d'), ' ', ra.user_memo) ")
			.where("              else ra.user_memo														")
			.where("         end user_memo																")

			//.where("       , ra.user_memo																")
			.where("       , m.deli_date as crt_date													")
			.where("       , ra.find_name																")
			.where("       , s.rett_resn_dvcd															")
			.where("       , s.rett_proc_dvcd															")
			.where("       , if(length(ra.invc_numb)>0 , '1','null') as stat							")
			.where("       , 1 as rnum																	")
			.where("       , s.wrhs_idcd																")
			.where("       , c1.clss_name as lcls_name													")
			.where("       , c2.clss_name as mcls_name													")
			.where("       , c3.clss_name as scls_name													")
			.where("       , null as istt_pric															")
			.where("       , null as pfit_rate															")
			.where("       , null as istt_amnt															")
			.where(" from       sale_rett_mast ra														")
//			.where(" left outer join cte a on a.invc_numb = ra.invc_numb								")
			.where(" left outer join cstm_mast cm on ra.cstm_idcd = cm.cstm_idcd						")
			.where(" left outer join dept_mast dm on ra.dept_idcd = dm.dept_idcd						")
			.where(" left outer join bzpl_mast bz on ra.bzpl_idcd = bz.bzpl_idcd						")
			.where(" left outer join sale_rett_item s on ra.invc_numb = s.invc_numb						")
			.where(" left outer join item_mast im on s.item_idcd = im.item_idcd							")
			.where(" left outer join item_clss c1 on im.lcls_idcd = c1.clss_idcd						")
			.where(" left outer join item_clss c2 on im.mcls_idcd = c2.clss_idcd						")
			.where(" left outer join item_clss c3 on im.scls_idcd = c3.clss_idcd						")
			.where(" left outer join wrhs_mast wh on s.wrhs_idcd = wh.wrhs_idcd							")
			.where(" left outer join user_mast um on ra.drtr_idcd = um.user_idcd						")
			.where(" left outer join sale_ostt_mast m on ra.invc_numb = m.invc_numb						")
			.where("  left outer join sale_ostt_item io on m.invc_numb = io.invc_numb					")
			.where(" left outer join acpt_mast ac on ac.invc_numb = s.acpt_numb							")
			.where(" where 1=1																			")
			.where(" and ra.line_stat<2																	")
			.where(" and     ra.find_name like %:find_name1%    " , arg.getParamText("find_name"  ))
			.where(" and     s.item_idcd  = :item_idcd1       "  , arg.getParamText("item_idcd"  ))
			.where(" and     ra.invc_date >= :invc_date3       " , arg.getParamText("invc_date1" ))
			.where(" and     ra.invc_date <= :invc_date4       " , arg.getParamText("invc_date2" ))
			.where(" and     m.deli_date >= :deli_date3       " , arg.getParamText("deli_date1" ))
			.where(" and     m.deli_date <= :deli_date4       " , arg.getParamText("deli_date2" ))
			.where(" and     s.acpt_numb  = :invc_numb1        " , arg.getParamText("invc_numb" ))
			.where(" and     ra.cstm_idcd  = :cstm_idcd1        " , arg.getParamText("cstm_idcd" ))
			.where(" and     s.wrhs_idcd  = :wrhs_idcd1        " , arg.getParamText("wrhs_idcd" ))
			.where(" and     ac.acpt_dvcd  = :acpt_dvcd1        " , arg.getParamText("acpt_dvcd" ))
			.where(" and     ra.line_stat  = :line_stat1        " , arg.getParamText("line_stat" ) , !"".equals(arg.getParamText("line_stat" )))
			.where(" group by ra.invc_numb																")
		;
*/

		if(arg.getParamText("chk" ).contains("1")){			//소계
			data.param
				.where(" union all																		")
				.where(" select  0 as line_stat															")
				.where("       , null as invc_numb														")
				.where("       , null as line_seqn														")
				.where("       , a.cstm_idcd as cstm_idcd												")
				.where("       , a.cstm_code															")
				.where("       , concat(a.cstm_name,' 계') as cstm_name									")
				.where("       , null as deli_date														")
				.where("       , null as invc_date														")
				.where("       , null as rett_date														")
				.where("       , null as drtr_name														")
				.where("       , null as acpt_drtr_name													")
				.where("       , null as item_idcd														")
				.where("       , null as item_code														")
				.where("       , null as item_name														")
				.where("       , null as item_spec														")
				.where("       , null as lott_numb														")
				.where("       , null as wrhs_name														")
				.where("       , sum(a.ostt_qntt) as ostt_qntt											")
				.where("       , null as rett_qntt														")
				.where("       , 0 as sale_pric															")
				.where("       , sum(a.sale_amnt) as sale_amnt											")
				.where("       , sum(a.vatx_amnt) as vatx_amnt											")
				.where("       , sum(a.ttsm_amnt) as ttsm_amnt											")
				.where("       , null as acpt_numb														")
				.where("       , null as acpt_dvcd														")
				.where("       , null as prod_trst_dvcd													")
				.where("       , null as user_memo														")
//				.where("       , a.deli_date as crt_date												")
				.where("       , case when a.acpt_dvcd = '1000' then a.deli_date						")
				.where("              when a.acpt_dvcd = '2000' then a.invc_date						")
				.where("              else a.deli_date													")
				.where("         End as crt_date														")
				.where("       , a.find_name															")
				.where("       , null as rett_resn_dvcd													")
				.where("       , null as rett_proc_dvcd													")
				.where("       , null as rett_yorn														")
				.where("       , 2 as rnum																")
				.where("       , a.wrhs_idcd															")
				.where("       , null as lcls_name														")
				.where("       , null as mcls_name														")
				.where("       , null as scls_name														")
				.where("       , null as istt_pric														")
				.where("       , null as pfit_rate														")
				.where("       , null as istt_amnt														")
				.where("       , null as trns_type														")
				.where(" from cte a																		")
//				.where(" group by a.deli_date, a.cstm_idcd												")
				.where(" group by case when a.acpt_dvcd = '1000' then a.deli_date						")
				.where("               when a.acpt_dvcd = '2000' then a.invc_date						")
				.where("               else a.deli_date													")
				.where("               End , a.cstm_idcd												")
			;
		}
		if(arg.getParamText("chk" ).contains("2")){			//일계
			data.param
				.where(" union all																		")
				.where(" select  0 as line_stat															")
				.where("       , null as invc_numb														")
				.where("       , null as line_seqn														")
				.where("       , max(a.cstm_idcd) as cstm_idcd											")
				.where("       , a.cstm_code															")
				.where("       , '일계' as cstm_name														")
				.where("       , null as deli_date														")
				.where("       , null as invc_date														")
				.where("       , null as rett_date														")
				.where("       , null as drtr_name														")
				.where("       , null as acpt_drtr_name													")
				.where("       , null as item_idcd														")
				.where("       , null as item_code														")
				.where("       , null as item_name														")
				.where("       , null as item_spec														")
				.where("       , null as lott_numb														")
				.where("       , null as wrhs_name														")
				.where("       , sum(a.ostt_qntt) as ostt_qntt											")
				.where("       , null as rett_qntt														")
				.where("       , 0 as sale_pric															")
				.where("       , sum(a.sale_amnt) as sale_amnt											")
				.where("       , sum(a.vatx_amnt) as vatx_amnt											")
				.where("       , sum(a.ttsm_amnt) as ttsm_amnt											")
				.where("       , null as acpt_numb														")
				.where("       , null as acpt_dvcd														")
				.where("       , null as prod_trst_dvcd													")
				.where("       , null as user_memo														")
//				.where("       , a.deli_date as crt_date												")
				.where("       , case when a.acpt_dvcd = '1000' then a.deli_date						")
				.where("              when a.acpt_dvcd = '2000' then a.invc_date						")
				.where("         else a.deli_date														")
				.where("         End as crt_date														")
				.where("       , a.find_name															")
				.where("       , null as rett_resn_dvcd													")
				.where("       , null as rett_proc_dvcd													")
				.where("       , null as rett_yorn														")
				.where("       , 3 as rnum																")
				.where("       , a.wrhs_idcd															")
				.where("       , null as lcls_name														")
				.where("       , null as mcls_name														")
				.where("       , null as scls_name														")
				.where("       , null as istt_pric														")
				.where("       , null as pfit_rate														")
				.where("       , null as istt_amnt														")
				.where("       , null as trns_type														")
				.where(" from cte a																		")
//				.where(" group by a.deli_date															")
				.where(" group by case when a.acpt_dvcd = '1000' then a.deli_date						")
				.where("               when a.acpt_dvcd = '2000' then a.invc_date						")
				.where("          else a.deli_date														")
				.where("          End																	")
			;
		}
		if(arg.getParamText("chk" ).contains("3")){			//월계
			data.param
				.where(" union all																		")
				.where(" select  0 as line_stat															")
				.where("       , null as invc_numb														")
				.where("       , null as line_seqn														")
				.where("       , max(a.cstm_idcd) as cstm_idcd											")
				.where("       , a.cstm_code															")
				.where("       , '월계' as cstm_name														")
				.where("       , null as deli_date														")
//				.where("       , substr(a.invc_date,1,6) as invc_date									")
				.where("       , case when a.acpt_dvcd = '1000' then substr(a.deli_date,1,6)			")
				.where("              when a.acpt_dvcd = '2000' then substr(a.invc_date,1,6)			")
				.where("         else substr(a.deli_date,1,6)											")
				.where("         End as invc_date														")
				.where("       , null as rett_date														")
				.where("       , null as drtr_name														")
				.where("       , null as acpt_drtr_name													")
				.where("       , null as item_idcd														")
				.where("       , null as item_code														")
				.where("       , null as item_name														")
				.where("       , null as item_spec														")
				.where("       , null as lott_numb														")
				.where("       , null as wrhs_name														")
				.where("       , sum(a.ostt_qntt) as ostt_qntt											")
				.where("       , null as rett_qntt														")
				.where("       , 0 as sale_pric															")
				.where("       , sum(a.sale_amnt) as sale_amnt											")
				.where("       , sum(a.vatx_amnt) as vatx_amnt											")
				.where("       , sum(a.ttsm_amnt) as ttsm_amnt											")
				.where("       , null as acpt_numb														")
				.where("       , null as acpt_dvcd														")
				.where("       , null as prod_trst_dvcd													")
				.where("       , null as user_memo														")
//				.where("       , concat(substr(a.deli_date,1,4),'99') as crt_date						")
				.where("       , case when a.acpt_dvcd = '1000' then concat(substr(a.deli_date,1,4),'99')	")
				.where("              when a.acpt_dvcd = '2000' then concat(substr(a.invc_date,1,4),'99')	")
				.where("         else concat(substr(a.deli_date,1,4),'99')								")
				.where("         End as crt_date														")
				.where("       , a.find_name															")
				.where("       , null as rett_resn_dvcd													")
				.where("       , null as rett_proc_dvcd													")
				.where("       , null as rett_yorn														")
				.where("       , 4 as rnum																")
				.where("       , a.wrhs_idcd															")
				.where("       , null as lcls_name														")
				.where("       , null as mcls_name														")
				.where("       , null as scls_name														")
				.where("       , null as istt_pric														")
				.where("       , null as pfit_rate														")
				.where("       , null as istt_amnt														")
				.where("       , null as trns_type														")
				.where(" from cte a																		")
//				.where(" group by substr(COALESCE(a.invc_date, a.deli_date), 1, 6)	 					")
				.where(" group by case when a.acpt_dvcd = '1000' then substr(COALESCE(a.deli_date, a.invc_date), 1, 6)	")
				.where("               when a.acpt_dvcd = '2000' then substr(COALESCE(a.invc_date, a.deli_date), 1, 6)	")
				.where("               else substr(COALESCE(a.invc_date, a.deli_date), 1, 6)			")
				.where("               End																")
			;
		}

		if(arg.getParamText("chk" ).contains("4")){			//합계
			data.param
				.where(" union all																		")
				.where(" select  0 as line_stat															")
				.where("       , null as invc_numb														")
				.where("       , null as line_seqn														")
				.where("       , max(a.cstm_idcd) as cstm_idcd											")
				.where("       , null as cstm_code														")
				.where("       , '전체 합계' as cstm_name														")
				.where("       , null as deli_date														")
				.where("       , null as invc_date														")
				.where("       , null as rett_date														")
				.where("       , null as drtr_name														")
				.where("       , null as acpt_drtr_name													")
				.where("       , null as item_idcd														")
				.where("       , null as item_code														")
				.where("       , null as item_name														")
				.where("       , null as item_spec														")
				.where("       , null as lott_numb														")
				.where("       , null as wrhs_name														")
				.where("       , sum(a.ostt_qntt) as ostt_qntt											")
				.where("       , null as rett_qntt														")
				.where("       , 0 as sale_pric															")
				.where("       , sum(a.sale_amnt) as sale_amnt											")
				.where("       , sum(a.vatx_amnt) as vatx_amnt											")
				.where("       , sum(a.ttsm_amnt) as ttsm_amnt											")
				.where("       , null as acpt_numb														")
				.where("       , null as acpt_dvcd														")
				.where("       , null as prod_trst_dvcd													")
				.where("       , null as user_memo														")
				.where("      , '99999999' as crt_date													")
				.where("       , a.find_name															")
				.where("       , null as rett_resn_dvcd													")
				.where("       , null as rett_proc_dvcd													")
				.where("       , null as rett_yorn														")
				.where("       , 5 as rnum																")
				.where("       , a.wrhs_idcd															")
				.where("       , null as lcls_name														")
				.where("       , null as mcls_name														")
				.where("       , null as scls_name														")
				.where("       , null as istt_pric														")
				.where("       , null as pfit_rate														")
				.where("       , null as istt_amnt														")
				.where("       , null as trns_type														")
				.where(" from cte a																		")
				.where(" group by '9999999'																")
			;
		}
		data.param
			.where(" order by crt_date, cstm_idcd, rnum, invc_numb, line_seqn limit 9999999				")
			.where(") a																					")
			.where("where 1=1																			")
		;
		return data.selectForMap();
	}

	public SqlResultMap getMaster2(HttpRequestArgument arg, int page, int rows, String sort) throws Exception {
		DataMessage data = arg.newStorage("POS");
		data.param
			.query("select  *																						")
		;
		// 삼정 - 원료이면 사용된 제품명을 비고에 표시한다.
		// 삼정 - 삼정수주 -> 주문생산, 재고주문, OEM수주 -> 주문생산, 재고생산을 대상으로 한다.
		data.param
			.where("from 																							")
			.where("(																								")
			.where("    with cte as ( 																				")
			.where("    select    a.invc_numb   , a.acpt_numb    , a.line_seqn    , a.sale_pric						")
			.where("            , a.ostt_qntt   , a.sale_amnt	 , a.vatx_amnt    , a.ttsm_amnt						")
			.where("            , a.line_stat   , a.sysm_memo    , a.lott_numb	  , a.item_idcd						")
			.where("            , b.invc_date   , b.deli_date 														")
			.where("            , c.cstm_code   , c.cstm_name         												")
			.where("            , i.item_code	, i.item_name    , i.item_spec        								")
			.where("            , w.wrhs_name																		")
			.where("            , u.user_name as drtr_name															")
			.where("            , m.acpt_dvcd    , json_value(m.json_data, '$.prod_trst_dvcd') as prod_trst_dvcd	")
			.where("            , 1 as 	trns_type																	")
			.where("        , case when i.acct_bacd = '1001' then 													")
			.where("                   (select concat('제품명 : ', im.item_name)										")
			.where("                      from acpt_item ai		 													")
			.where("                           left outer join item_mast im on im.item_idcd = ai.item_idcd			")
			.where("                     where 1 = 1																")
			.where("                       and ai.invc_numb = a.acpt_numb											")
			.where("                       and ai.line_seqn = a.acpt_seqn)											")
			.where("               else	a.user_memo																	")
			.where("          end user_memo																			")
			.where("    from  sale_ostt_item a																		")
			.where("          left outer join sale_ostt_mast b on a.invc_numb = b.invc_numb							")
			.where("          left outer join acpt_mast m on m.invc_numb = a.acpt_numb								")
			.where("          left outer join cstm_mast c on b.cstm_idcd = c.cstm_idcd								")
			.where("          left outer join item_mast i on a.item_idcd = i.item_idcd								")
			.where("          left outer join user_mast u on b.drtr_idcd = u.user_idcd								")
			.where("          left outer join wrhs_mast w on a.wrhs_idcd = w.wrhs_idcd								")
			.where("    where 1 = 1																					")
			.where("    and   json_value(a.json_data, '$.trns_date') is null										")
			.where("    and   i.find_name like %:find_name1%    " , arg.getParamText("find_name"  ))
			.where("    and   a.item_idcd  = :item_idcd1        "  , arg.getParamText("item_idcd"  ))
			.where("    and   b.invc_date >= :invc_date11       " , arg.getParamText("invc_date1" ))
			.where("    and   b.invc_date <= :invc_date12       " , arg.getParamText("invc_date2" ))
			.where("    and   a.deli_date >= :deli_date11       " , arg.getParamText("deli_date1" ))
			.where("    and   a.deli_date <= :deli_date12       " , arg.getParamText("deli_date2" ))
			.where("    and   a.acpt_numb  = :invc_numb1        " , arg.getParamText("invc_numb" ))
			.where("    and   b.cstm_idcd  = :cstm_idcd1        " , arg.getParamText("cstm_idcd" ))
			.where("    and   a.wrhs_idcd  = :wrhs_idcd1        " , arg.getParamText("wrhs_idcd" ))
			.where("    and   m.acpt_dvcd  = :acpt_dvcd1        " , arg.getParamText("acpt_dvcd" ))
			.where("    and   b.line_stat  = :line_stat1        " , arg.getParamText("line_stat" ) , !"".equals(arg.getParamText("line_stat" )))
			.where("    and   ((m.acpt_dvcd = '1000' and json_value(m.json_data, '$.prod_trst_dvcd') <> '2000') or (m.acpt_dvcd = '2000' and json_value(m.json_data, '$.prod_trst_dvcd') <> '3000')) ")
		;
		// 이월품목
		data.param
			.where("    union all")
			.where("    select    a.invc_numb   , a.acpt_numb    , a.line_seqn    , a.sale_pric							")
			.where("            , a.ostt_qntt   , a.sale_amnt	 , a.vatx_amnt    , a.ttsm_amnt							")
			.where("            , a.line_stat   , a.sysm_memo    , a.lott_numb	  , a.item_idcd							")
			.where("            , b.invc_date   , json_value(a.json_data, '$.trns_date') as deli_date					")
			.where("            , c.cstm_code   , c.cstm_name         													")
			.where("            , i.item_code	, i.item_name    , i.item_spec        									")
			.where("            , w.wrhs_name																			")
			.where("            , u.user_name as drtr_name																")
			.where("            , m.acpt_dvcd    , json_value(m.json_data, '$.prod_trst_dvcd') as prod_trst_dvcd		")
			.where("            , 2 as 	trns_type																		")
			.where("        , case when i.acct_bacd = '1001' then 													")
			.where("                   (select concat('제품명 : ', im.item_name)										")
			.where("                      from acpt_item ai		 													")
			.where("                           left outer join item_mast im on im.item_idcd = ai.item_idcd			")
			.where("                     where 1 = 1																")
			.where("                       and ai.invc_numb = a.acpt_numb											")
			.where("                       and ai.line_seqn = a.acpt_seqn)											")
			.where("               else	a.user_memo																	")
			.where("          end user_memo																			")
			.where("    from   sale_ostt_item a																			")
			.where("           left outer join sale_ostt_mast b on a.invc_numb = b.invc_numb							")
			.where("           left outer join acpt_mast m on m.invc_numb = a.acpt_numb									")
			.where("           left outer join cstm_mast c on b.cstm_idcd = c.cstm_idcd									")
			.where("           left outer join item_mast i on a.item_idcd = i.item_idcd									")
			.where("           left outer join user_mast u on b.drtr_idcd = u.user_idcd									")
			.where("           left outer join wrhs_mast w on a.wrhs_idcd = w.wrhs_idcd									")
			.where("    where  1 = 1																					")
			.where("    and    json_value(a.json_data, '$.trns_date') is not null										")
			.where("    and    i.find_name like %:find_name2%	" , arg.getParamText("find_name"  ))
			.where("    and    a.item_idcd  = :item_idcd2		" , arg.getParamText("item_idcd"  ))
			.where("    and    b.invc_date >= :invc_date21		" , arg.getParamText("invc_date1" ))
			.where("    and    b.invc_date <= :invc_date22		" , arg.getParamText("invc_date2" ))
			.where("    and    json_value(a.json_data, '$.trns_date') >= :deli_date21       " , arg.getParamText("deli_date1" ))
			.where("    and    json_value(a.json_data, '$.trns_date') <= :deli_date22       " , arg.getParamText("deli_date2" ))
			.where("    and    a.acpt_numb  = :invc_numb2		" , arg.getParamText("invc_numb" ))
			.where("    and    b.cstm_idcd  = :cstm_idcd2		" , arg.getParamText("cstm_idcd" ))
			.where("    and    a.wrhs_idcd  = :wrhs_idcd2		" , arg.getParamText("wrhs_idcd" ))
			.where("    and    m.acpt_dvcd  = :acpt_dvcd2		" , arg.getParamText("acpt_dvcd" ))
			.where("    and    b.line_stat  = :line_stat2		" , arg.getParamText("line_stat" ) , !"".equals(arg.getParamText("line_stat" )))
			.where("    and    ((m.acpt_dvcd = '1000' and json_value(m.json_data, '$.prod_trst_dvcd') <> '2000') or (m.acpt_dvcd = '2000' and json_value(m.json_data, '$.prod_trst_dvcd') <> '3000')) ")
		;
		// 반품
		data.param
			.where("    union all")
			.where("    select    a.invc_numb   , a.acpt_numb	, a.line_seqn     , a.sale_pric							")
			.where("            , a.rett_qntt  as ostt_qntt 														")
			.where("            , (a.rett_qntt * a.sale_pric)  as sale_amnt											")
			.where("            , case when a.vatx_incl_yorn = '1' then ((a.rett_qntt * a.sale_pric) * 0.1)  		")
			.where("                   else 0																			")
			.where("              end vatx_amnt 																		")
			.where("            , case when a.vatx_incl_yorn = '1' then ((a.rett_qntt * a.sale_pric) ) + (((a.rett_qntt * a.sale_pric) * 0.1) * -1)	")
			.where("                   else (a.rett_qntt * a.sale_pric) 											")
			.where("              end ttsm_amnt 																		")
			.where("            , a.line_stat   , a.sysm_memo	 , a.lott_numb    , a.item_idcd							")
			.where("            , b.invc_date   , b.invc_date as deli_dat												")
			.where("            , c.cstm_code   , c.cstm_name															")
			.where("            , i.item_code	, i.item_name    , i.item_spec        									")
			.where("            , w.wrhs_name																			")
			.where("            , u.user_name as drtr_name																")
			.where("            , m.acpt_dvcd   , json_value(m.json_data, '$.prod_trst_dvcd') as prod_trst_dvcd			")
			.where("            , 3 as 	trns_type 																		")
			.where("            , case when i.acct_bacd = '1001' then 													")
			.where("                   (select concat('제품명 : ', im.item_name)											")
			.where("                      from acpt_item ai		 														")
			.where("                           left outer join item_mast im on im.item_idcd = ai.item_idcd				")
			.where("                     where 1 = 1																	")
			.where("                       and ai.invc_numb = a.acpt_numb												")
			.where("                       and ai.line_seqn = a.acpt_seqn)												")
			.where("                   else	a.user_memo																	")
			.where("              end user_memo																			")
			.where("     from   sale_rett_item a																		")
			.where("            left outer join sale_rett_mast b on b.invc_numb = a.invc_numb							")
			.where("            left outer join acpt_mast m  on m.invc_numb = a.acpt_numb								")
			.where("            left outer join cstm_mast c  on c.cstm_idcd = b.cstm_idcd								")
			.where("            left outer join item_mast i  on i.item_idcd = a.item_idcd								")
			.where("            left outer join user_mast u  on u.user_idcd = b.drtr_idcd								")
			.where("            left outer join wrhs_mast w  on w.wrhs_idcd = a.wrhs_idcd								")
			.where("     where  1 = 1																					")
			.where("     and    i.find_name like %:find_name3%   " , arg.getParamText("find_name" ))
//			.where("     and    m.acpt_dvcd = '1000'											"  )
			.where("     and    a.item_idcd  = :item_idcd3       " , arg.getParamText("item_idcd" ))
			.where("     and    b.invc_date >= :invc_date31       " , arg.getParamText("invc_date1"))
			.where("     and    b.invc_date <= :invc_date32       " , arg.getParamText("invc_date2"))
			.where("     and    b.invc_date >= :deli_date31       " , arg.getParamText("deli_date1"))
			.where("     and    b.invc_date <= :deli_date32       " , arg.getParamText("deli_date2"))
			.where("     and    a.acpt_numb  = :invc_numb3       " , arg.getParamText("invc_numb" ))
			.where("     and    b.cstm_idcd  = :cstm_idcd3       " , arg.getParamText("cstm_idcd" ))
			.where("     and    a.wrhs_idcd  = :wrhs_idcd3       " , arg.getParamText("wrhs_idcd" ))
			.where("     and    m.acpt_dvcd  = :acpt_dvcd3       " , arg.getParamText("acpt_dvcd" ))
			.where("     and    b.line_stat  = :line_stat3       " , arg.getParamText("line_stat" ) , !"".equals(arg.getParamText("line_stat" )))
			.where("     and    ((m.acpt_dvcd = '1000' and json_value(m.json_data, '$.prod_trst_dvcd') <> '2000') or (m.acpt_dvcd = '2000' and json_value(m.json_data, '$.prod_trst_dvcd') <> '3000')) ")
			.where(") 																								")
		;
		data.param
			.where(" select  a.line_stat																			")
			.where("       , a.invc_numb																			")
			.where("       , a.line_seqn																			")
			.where("       , a.cstm_code																			")
			.where("       , a.cstm_name																			")
			.where("       , a.deli_date																			")
			.where("       , a.invc_date																			")
			.where("       , a.drtr_name																			")
			.where("       , a.item_idcd																			")
			.where("       , a.item_code																			")
			.where("       , a.item_name																			")
			.where("       , a.item_spec																			")
			.where("       , a.lott_numb																			")
			.where("       , a.wrhs_name																			")
			.where("       , a.ostt_qntt																			")
			.where("       , a.sale_pric																			")
			.where("       , a.sale_amnt																			")
			.where("       , a.vatx_amnt																			")
			.where("       , a.ttsm_amnt																			")
			.where("       , a.acpt_numb																			")
			.where("       , a.acpt_dvcd																			")
			.where("       , a.prod_trst_dvcd																		")
			.where("       , a.user_memo																			")
			//			.where("       , a.deli_date as sort_date																")
			.where("       , case when a.acpt_dvcd = '1000' then deli_date											")
			.where("              when a.acpt_dvcd = '2000' then invc_date											")
			.where("              else deli_date																	")
			.where("              End as sort_date																	")
			.where("       , 1 as rnum																				")
			.where("       , a.trns_type																			")
			.where(" from cte a																						")
		;

		// 일계
		if(arg.getParamText("chk" ).contains("2")) {
			data.param
				.where(" union all																					")
				.where(" select  0 as line_stat																		")
				.where("       , null as invc_numb																	")
				.where("       , null as line_seqn																	")
				.where("       , null as cstm_code																	")
				.where("       , null as cstm_name																	")
				.where("       , null as deli_date																	")
				.where("       , null as invc_date																	")
				.where("       , null as drtr_name																	")
				.where("       , max(a.item_idcd) as item_idcd														")
				.where("       , null as item_code																	")
				.where("       , case when a.acpt_dvcd = '1000' then concat(a.item_name,' ','일계  -  ',  substr(a.deli_date, 1, 4), '-', substr(a.deli_date, 5, 2), '-', substr(a.deli_date, 7, 2))	")
				.where("              when a.acpt_dvcd = '2000' then concat(a.item_name,' ','일계  -  ',  substr(a.invc_date, 1, 4), '-', substr(a.invc_date, 5, 2), '-', substr(a.invc_date, 7, 2))	")
				.where("              else concat(a.item_name,' ','일계  -  ',  substr(a.deli_date, 1, 4), '-', substr(a.deli_date, 5, 2), '-', substr(a.deli_date, 7, 2))								")
				.where("              End as item_name")
//				.where("       , concat(a.item_name,' ','일계  -  ',  substr(a.deli_date, 1, 4), '-', substr(a.deli_date, 5, 2), '-', substr(a.deli_date, 7, 2)) as item_name ")
				.where("       , null as item_spec																	")
				.where("       , null as lott_numb																	")
				.where("       , null as wrhs_name																	")
				.where("       , sum(a.ostt_qntt) as ostt_qntt														")
				.where("       , 0 as sale_pric																		")
				.where("       , sum(a.sale_amnt) as sale_amnt														")
				.where("       , sum(a.vatx_amnt) as vatx_amnt														")
				.where("       , sum(a.ttsm_amnt) as ttsm_amnt														")
				.where("       , null as acpt_numb																	")
				.where("       , null as acpt_dvcd																	")
				.where("       , null as prod_trst_dvcd																")
				.where("       , null as user_memo																	")
//				.where("       , a.deli_date as sort_date															")
				.where("       , case when a.acpt_dvcd = '1000' then concat(substr(a.deli_date, 1, 8), '9')			")
				.where("              when a.acpt_dvcd = '2000' then concat(substr(a.invc_date, 1, 8), '9')			")
				.where("              else concat(substr(a.deli_date, 1, 8), '9')									")
				.where("              End as sort_date																")
				.where("       , 2 as rnum																			")
				.where("       , null as trns_type																	")
				.where(" from  cte a																				")
//				.where(" group by a.item_idcd , a.deli_date															")
				.where(" group by a.item_idcd ,																		")
				.where("          case when a.acpt_dvcd = '1000' then concat(substr(a.deli_date, 1, 8), '9')		")
				.where("               when a.acpt_dvcd = '2000' then concat(substr(a.invc_date, 1, 8), '9')		")
				.where("          else  concat(substr(a.deli_date, 1, 8), '9')										")
				.where("          End																				")
			;
		}

		// 품목별 합계
		if(arg.getParamText("chk" ).contains("1")) {
			data.param
				.where(" union all																					")
				.where(" select  0 as line_stat																		")
				.where("       , null as invc_numb																	")
				.where("       , null as line_seqn																	")
				.where("       , null as cstm_code																	")
				.where("       , null as cstm_name																	")
				.where("       , null as deli_date																	")
				.where("       , null as invc_date																	")
				.where("       , null as drtr_name																	")
				.where("       , max(a.item_idcd) as item_idcd														")
				.where("       , null as item_code																	")
				.where("       , concat(a.item_name,' ','합계  ') as item_name											")
				.where("       , null as item_spec																	")
				.where("       , null as lott_numb																	")
				.where("       , null as wrhs_name																	")
				.where("       , sum(a.ostt_qntt) as ostt_qntt														")
				.where("       , 0 as sale_pric																		")
				.where("       , sum(a.sale_amnt) as sale_amnt														")
				.where("       , sum(a.vatx_amnt) as vatx_amnt														")
				.where("       , sum(a.ttsm_amnt) as ttsm_amnt														")
				.where("       , null as acpt_numb																	")
				.where("       , null as acpt_dvcd																	")
				.where("       , null as prod_trst_dvcd																")
				.where("       , null as user_memo																	")
				.where("      , '77777777' as sort_date																")
				.where("       , 3 as rnum																			")
				.where("       , null as trns_type																	")
				.where(" from cte a																					")
				.where(" group by a.item_idcd , '77777777'															")
			;
		}

		// 월계
		if(arg.getParamText("chk" ).contains("3")) {
			data.param
				.where(" union all																					")
				.where(" select  0 as line_stat																		")
				.where("       , null as invc_numb																	")
				.where("       , null as line_seqn																	")
				.where("       , null as cstm_code																	")
				.where("       , null as cstm_name																	")
				.where("       , null as deli_date																	")
				.where("       , null as invc_date																	")
				.where("       , null as drtr_name																	")
				.where("       , (max(a.item_idcd)+1) as item_idcd													")
				.where("       , null as item_code																	")
				.where("       , concat( '월계 - ', substr(a.deli_date, 1, 4), '-', substr(a.deli_date, 5, 2)) as item_name	")
				.where("       , null as item_spec																	")
				.where("       , null as lott_numb																	")
				.where("       , null as wrhs_name																	")
				.where("       , sum(a.ostt_qntt) as ostt_qntt														")
				.where("       , 0 as sale_pric																		")
				.where("       , sum(a.sale_amnt) as sale_amnt														")
				.where("       , sum(a.vatx_amnt) as vatx_amnt														")
				.where("       , sum(a.ttsm_amnt) as ttsm_amnt														")
				.where("       , null as acpt_numb																	")
				.where("       , null as acpt_dvcd																	")
				.where("       , null as prod_trst_dvcd																")
				.where("       , null as user_memo																	")
				.where("       , '99999999' as sort_date															")
				.where("       , 4 as rnum																			")
				.where("       , null as trns_type																	")
				.where(" from  cte a																				")
				.where(" group by '99999999', concat(substr(a.deli_date, 1, 6), '99')								")
			;
		}

		// 합계
		if(arg.getParamText("chk" ).contains("4")) {
			data.param
				.where(" union all																					")
				.where(" select  0 as line_stat																		")
				.where("       , null as invc_numb																	")
				.where("       , null as line_seqn																	")
				.where("       , null as cstm_code																	")
				.where("       , null as cstm_name																	")
				.where("       , null as deli_date																	")
				.where("       , null as invc_date																	")
				.where("       , null as drtr_name																	")
				.where("       , (max(a.item_idcd)+2) as item_idcd													")
				.where("       , null as item_code																	")
				.where("       , '전체 합계' as item_name																")
				.where("       , null as item_spec																	")
				.where("       , null as lott_numb																	")
				.where("       , null as wrhs_name																	")
				.where("       , sum(a.ostt_qntt) as ostt_qntt														")
				.where("       , 0 as sale_pric																		")
				.where("       , sum(a.sale_amnt) as sale_amnt														")
				.where("       , sum(a.vatx_amnt) as vatx_amnt														")
				.where("       , sum(a.ttsm_amnt) as ttsm_amnt														")
				.where("       , null as acpt_numb																	")
				.where("       , null as acpt_dvcd																	")
				.where("       , null as prod_trst_dvcd																")
				.where("       , null as user_memo																	")
				.where("      , '99999999' as sort_date																")
				.where("       , 5 as rnum																			")
				.where("       , null as trns_type																	")
				.where(" from cte a																					")
				.where(" group by '9999999'																			")
			;
		}

		data.param
			.where(" order by item_idcd, sort_date, rnum, invc_numb, line_seqn										")
			.where(") a																								")
		;

		return data.selectForMap();
	}

	public SqlResultMap getMaster3(HttpRequestArgument arg, int page, int rows, String sort) throws Exception {

		DataMessage data = arg.newStorage("POS");
		data.param
			.query("select  *																						")
		;
		// 삼정 - 원료이면 사용된 제품명을 비고에 표시한다.
		// 삼정 - 삼정수주 -> 주문생산, 재고주문, OEM수주 -> 주문생산, 재고생산을 대상으로 한다.
		data.param
			.where("from 																							")
			.where("(																								")
			.where("    with cte as ( 																				")
			.where("    select    a.invc_numb   , a.acpt_numb    , a.line_seqn    , a.sale_pric						")
			.where("            , a.ostt_qntt   , a.sale_amnt	 , a.vatx_amnt    , a.ttsm_amnt						")
			.where("            , a.line_stat   , a.sysm_memo    , a.lott_numb	  , a.item_idcd						")
			.where("            , b.invc_date   , b.deli_date 														")
			.where("            , c.cstm_code   , c.cstm_name    , b.cstm_idcd										")
			.where("            , i.item_code	, i.item_name    , i.item_spec        								")
			.where("            , w.wrhs_name																		")
			.where("            , u.user_name as drtr_name															")
			.where("            , m.acpt_dvcd    , json_value(m.json_data, '$.prod_trst_dvcd') as prod_trst_dvcd	")
			.where("            , 1 as 	trns_type																	")
			.where("            , case when i.acct_bacd = '1001' then 												")
			.where("                       ( select concat('제품명 : ', im.item_name)									")
			.where("                         from   acpt_item ai		 											")
			.where("                                left outer join item_mast im on im.item_idcd = ai.item_idcd		")
			.where("                         where  1 = 1															")
			.where("                         and    ai.invc_numb = a.acpt_numb										")
			.where("                         and    ai.line_seqn = a.acpt_seqn )									")
			.where("                   else a.user_memo																")
			.where("              end user_memo																		")
			.where("    from  sale_ostt_item a																		")
			.where("          left outer join sale_ostt_mast b on a.invc_numb = b.invc_numb							")
			.where("          left outer join acpt_mast m on m.invc_numb = a.acpt_numb								")
			.where("          left outer join cstm_mast c on b.cstm_idcd = c.cstm_idcd								")
			.where("          left outer join item_mast i on a.item_idcd = i.item_idcd								")
			.where("          left outer join user_mast u on b.drtr_idcd = u.user_idcd								")
			.where("          left outer join wrhs_mast w on a.wrhs_idcd = w.wrhs_idcd								")
			.where("    where 1 = 1																					")
			.where("    and   json_value(a.json_data, '$.trns_date') is null										")
			.where("    and   i.find_name like %:find_name1%    " , arg.getParamText("find_name"  ))
			.where("    and   a.item_idcd  = :item_idcd1        "  , arg.getParamText("item_idcd"  ))
			.where("    and   b.invc_date >= :invc_date11       " , arg.getParamText("invc_date1" ))
			.where("    and   b.invc_date <= :invc_date12       " , arg.getParamText("invc_date2" ))
			.where("    and   a.deli_date >= :deli_date11       " , arg.getParamText("deli_date1" ))
			.where("    and   a.deli_date <= :deli_date12       " , arg.getParamText("deli_date2" ))
			.where("    and   a.acpt_numb  = :invc_numb1        " , arg.getParamText("invc_numb" ))
			.where("    and   b.cstm_idcd  = :cstm_idcd1        " , arg.getParamText("cstm_idcd" ))
			.where("    and   a.wrhs_idcd  = :wrhs_idcd1        " , arg.getParamText("wrhs_idcd" ))
			.where("    and   m.acpt_dvcd  = :acpt_dvcd1        " , arg.getParamText("acpt_dvcd" ))
			.where("    and   b.line_stat  = :line_stat1        " , arg.getParamText("line_stat" ) , !"".equals(arg.getParamText("line_stat" )))
			.where("    and   ((json_value(m.json_data, '$.prod_trst_dvcd') <> '2000') or (m.acpt_dvcd = '2000' and json_value(m.json_data, '$.prod_trst_dvcd') <> '3000')) ")
		;
		// 이월품목
		data.param
			.where("    union all")
			.where("    select    a.invc_numb   , a.acpt_numb    , a.line_seqn    , a.sale_pric							")
			.where("            , a.ostt_qntt   , a.sale_amnt	 , a.vatx_amnt    , a.ttsm_amnt							")
			.where("            , a.line_stat   , a.sysm_memo    , a.lott_numb	  , a.item_idcd							")
			.where("            , b.invc_date   , json_value(a.json_data, '$.trns_date') as deli_date					")
			.where("            , c.cstm_code   , c.cstm_name    , b.cstm_idcd											")
			.where("            , i.item_code	, i.item_name    , i.item_spec        									")
			.where("            , w.wrhs_name																			")
			.where("            , u.user_name as drtr_name																")
			.where("            , m.acpt_dvcd    , json_value(m.json_data, '$.prod_trst_dvcd') as prod_trst_dvcd		")
			.where("            , 2 as 	trns_type																		")
			.where("            , case when i.acct_bacd = '1001' then 													")
			.where("                       ( select concat('제품명 : ', im.item_name)										")
			.where("                         from   acpt_item ai		 												")
			.where("                                left outer join item_mast im on im.item_idcd = ai.item_idcd			")
			.where("                         where  1 = 1																")
			.where("                         and    ai.invc_numb = a.acpt_numb											")
			.where("                         and    ai.line_seqn = a.acpt_seqn )										")
			.where("                   else a.user_memo																	")
			.where("              end user_memo																			")
			.where("    from   sale_ostt_item a																			")
			.where("           left outer join sale_ostt_mast b on a.invc_numb = b.invc_numb							")
			.where("           left outer join acpt_mast m on m.invc_numb = a.acpt_numb									")
			.where("           left outer join cstm_mast c on b.cstm_idcd = c.cstm_idcd									")
			.where("           left outer join item_mast i on a.item_idcd = i.item_idcd									")
			.where("           left outer join user_mast u on b.drtr_idcd = u.user_idcd									")
			.where("           left outer join wrhs_mast w on a.wrhs_idcd = w.wrhs_idcd									")
			.where("    where  1 = 1																					")
			.where("    and    json_value(a.json_data, '$.trns_date') is not null										")
			.where("    and    i.find_name like %:find_name2%	" , arg.getParamText("find_name"  ))
			.where("    and    a.item_idcd  = :item_idcd2		" , arg.getParamText("item_idcd"  ))
			.where("    and    b.invc_date >= :invc_date21		" , arg.getParamText("invc_date1" ))
			.where("    and    b.invc_date <= :invc_date22		" , arg.getParamText("invc_date2" ))
			.where("    and    json_value(a.json_data, '$.trns_date') >= :deli_date21       " , arg.getParamText("deli_date1" ))
			.where("    and    json_value(a.json_data, '$.trns_date') <= :deli_date22       " , arg.getParamText("deli_date2" ))
			.where("    and    a.acpt_numb  = :invc_numb2		" , arg.getParamText("invc_numb" ))
			.where("    and    b.cstm_idcd  = :cstm_idcd2		" , arg.getParamText("cstm_idcd" ))
			.where("    and    a.wrhs_idcd  = :wrhs_idcd2		" , arg.getParamText("wrhs_idcd" ))
			.where("    and    m.acpt_dvcd  = :acpt_dvcd2		" , arg.getParamText("acpt_dvcd" ))
			.where("    and    b.line_stat  = :line_stat2		" , arg.getParamText("line_stat" ) , !"".equals(arg.getParamText("line_stat" )))
			.where("    and    ((m.acpt_dvcd = '1000' and json_value(m.json_data, '$.prod_trst_dvcd') <> '2000') or (m.acpt_dvcd = '2000' and json_value(m.json_data, '$.prod_trst_dvcd') <> '3000')) ")
		;
		// 반품
		data.param
			.where("    union all")
			.where("    select    a.invc_numb   , a.acpt_numb	, a.line_seqn     , a.sale_pric							")
			.where("            , a.rett_qntt as ostt_qntt 																")
			.where("            , (a.rett_qntt * a.sale_pric)  as sale_amnt												")
			.where("            , case when a.vatx_incl_yorn = '1' then ((a.rett_qntt * a.sale_pric) * 0.1)				")
			.where("                   else 0																			")
			.where("              end vatx_amnt 																		")
			.where("            , case when a.vatx_incl_yorn = '1' then ((a.rett_qntt * a.sale_pric) ) + (((a.rett_qntt * a.sale_pric) * 0.1) )	")
			.where("                   else (a.rett_qntt * a.sale_pric) 												")
			.where("              end ttsm_amnt 																		")
			.where("            , a.line_stat   , a.sysm_memo	 , a.lott_numb    , a.item_idcd							")
			.where("            , b.invc_date   , b.invc_date as deli_dat												")
			.where("            , c.cstm_code   , c.cstm_name	 , b.cstm_idcd											")
			.where("            , i.item_code	, i.item_name    , i.item_spec        									")
			.where("            , w.wrhs_name																			")
			.where("            , u.user_name as drtr_name																")
			.where("            , m.acpt_dvcd   , json_value(m.json_data, '$.prod_trst_dvcd') as prod_trst_dvcd			")
			.where("            , 3 as 	trns_type 																		")
			.where("            , case when i.acct_bacd = '1001' then 													")
			.where("                   (select concat('제품명 : ', im.item_name)											")
			.where("                      from acpt_item ai		 														")
			.where("                           left outer join item_mast im on im.item_idcd = ai.item_idcd				")
			.where("                     where 1 = 1																	")
			.where("                       and ai.invc_numb = a.acpt_numb												")
			.where("                       and ai.line_seqn = a.acpt_seqn)												")
			.where("                   else	a.user_memo																	")
			.where("              end user_memo																			")
			.where("     from   sale_rett_item a																		")
			.where("            left outer join sale_rett_mast b on b.invc_numb = a.invc_numb							")
			.where("            left outer join acpt_mast m  on m.invc_numb = a.acpt_numb								")
			.where("            left outer join cstm_mast c  on c.cstm_idcd = b.cstm_idcd								")
			.where("            left outer join item_mast i  on i.item_idcd = a.item_idcd								")
			.where("            left outer join user_mast u  on u.user_idcd = b.drtr_idcd								")
			.where("            left outer join wrhs_mast w  on w.wrhs_idcd = a.wrhs_idcd								")
			.where("     where  1 = 1																					")
			.where("     and    i.find_name like %:find_name3%   " , arg.getParamText("find_name" ))
//			.where("     and    m.acpt_dvcd = '1000'											"  )
			.where("     and    a.item_idcd  = :item_idcd3       " , arg.getParamText("item_idcd" ))
			.where("     and    b.invc_date >= :invc_date31      " , arg.getParamText("invc_date1"))
			.where("     and    b.invc_date <= :invc_date32      " , arg.getParamText("invc_date2"))
			.where("     and    b.invc_date >= :deli_date31      " , arg.getParamText("deli_date1"))
			.where("     and    b.invc_date <= :deli_date32      " , arg.getParamText("deli_date2"))
			.where("     and    a.acpt_numb  = :invc_numb3       " , arg.getParamText("invc_numb" ))
			.where("     and    b.cstm_idcd  = :cstm_idcd3       " , arg.getParamText("cstm_idcd" ))
			.where("     and    a.wrhs_idcd  = :wrhs_idcd3       " , arg.getParamText("wrhs_idcd" ))
			.where("     and    m.acpt_dvcd  = :acpt_dvcd3       " , arg.getParamText("acpt_dvcd" ))
			.where("     and    b.line_stat  = :line_stat3       " , arg.getParamText("line_stat" ) , !"".equals(arg.getParamText("line_stat" )))
			.where("     and    ((json_value(m.json_data, '$.prod_trst_dvcd') <> '2000') or (m.acpt_dvcd = '2000' and json_value(m.json_data, '$.prod_trst_dvcd') <> '3000')) ")
			.where(") 																								")
		;
		data.param
			.where(" select  a.line_stat																			")
			.where("       , a.invc_numb																			")
			.where("       , a.line_seqn																			")
			.where("       , a.cstm_idcd																			")
			.where("       , a.cstm_code																			")
			.where("       , a.cstm_name																			")
			.where("       , a.deli_date																			")
			.where("       , a.invc_date																			")
			.where("       , a.drtr_name																			")
			.where("       , a.item_code																			")
			.where("       , a.item_name																			")
			.where("       , a.item_spec																			")
			.where("       , a.lott_numb																			")
			.where("       , a.wrhs_name																			")
			.where("       , a.ostt_qntt																			")
			.where("       , a.sale_pric																			")
			.where("       , a.sale_amnt																			")
			.where("       , a.vatx_amnt																			")
			.where("       , a.ttsm_amnt																			")
			.where("       , a.acpt_numb																			")
			.where("       , a.acpt_dvcd																			")
			.where("       , a.prod_trst_dvcd																		")
			.where("       , a.user_memo																			")
//			.where("       , a.deli_date as sort_date																")
			.where("       , case when a.acpt_dvcd = '1000' then deli_date											")
			.where("              when a.acpt_dvcd = '2000' then invc_date											")
			.where("              else deli_date																	")
			.where("              End as sort_date																	")
			.where("       , 1 as rnum																				")
			.where("       , a.trns_type																			")
			.where(" from cte a																						")
		;
		// 일계
		if(arg.getParamText("chk" ).contains("2")) {
			data.param
				.where(" union all																					")
				.where(" select  0 as line_stat																		")
				.where("       , null as invc_numb																	")
				.where("       , null as line_seqn																	")
				.where("       , max(a.cstm_idcd) as cstm_idcd														")
				.where("       , a.cstm_idcd as cstm_code															")
//				.where("       , concat(a.cstm_name,' ','일계  -  ',  substr(a.deli_date, 1, 4), '-', substr(a.deli_date, 5, 2), '-', substr(a.deli_date, 7, 2)) as cstm_name ")
				.where("       , case when a.acpt_dvcd = '1000' then concat(a.cstm_name,' ','일계  -  ',  substr(a.deli_date, 1, 4), '-', substr(a.deli_date, 5, 2), '-', substr(a.deli_date, 7, 2))	")
				.where("              when a.acpt_dvcd = '2000' then concat(a.cstm_name,' ','일계  -  ',  substr(a.invc_date, 1, 4), '-', substr(a.invc_date, 5, 2), '-', substr(a.invc_date, 7, 2))	")
				.where("              else concat(a.cstm_name,' ','일계  -  ',  substr(a.invc_date, 1, 4), '-', substr(a.invc_date, 5, 2), '-', substr(a.invc_date, 7, 2))								")
				.where("              End as cstm_name																")
				.where("       , null  as deli_date																	")
				.where("       , null as invc_date																	")
				.where("       , null as drtr_name																	")
				.where("       , null as item_code																	")
				.where("       , null as item_name 																	")
				.where("       , null as item_spec																	")
				.where("       , null as lott_numb																	")
				.where("       , null as wrhs_name																	")
				.where("       , sum(a.ostt_qntt) as ostt_qntt														")
				.where("       , 0 as sale_pric																		")
				.where("       , sum(a.sale_amnt) as sale_amnt														")
				.where("       , sum(a.vatx_amnt) as vatx_amnt														")
				.where("       , sum(a.ttsm_amnt) as ttsm_amnt														")
				.where("       , null as acpt_numb																	")
				.where("       , null as acpt_dvcd																	")
				.where("       , null as prod_trst_dvcd																")
				.where("       , null as user_memo																	")
//				.where("       , a.deli_date as sort_date															")
				.where("       , case when a.acpt_dvcd = '1000' then concat(substr(a.deli_date, 1, 8), '9')			")
				.where("              when a.acpt_dvcd = '2000' then concat(substr(a.invc_date, 1, 8), '9')			")
				.where("              else concat(substr(a.deli_date, 1, 8), '9')									")
				.where("              End as sort_date																")
				.where("       , 2 as rnum																			")
				.where("       , null as trns_type																	")
				.where(" from  cte a																				")
//				.where(" group by a.cstm_idcd , a.deli_date															")
				.where(" group by a.cstm_idcd , 																	")
				.where("          case when a.acpt_dvcd = '1000' then concat(substr(a.deli_date, 1, 8), '9')		")
				.where("               when a.acpt_dvcd = '2000' then concat(substr(a.invc_date, 1, 8), '9')		")
				.where("          else  concat(substr(a.deli_date, 1, 8), '9')										")
				.where("          End																				")
			;
		}

		// 월계
		if(arg.getParamText("chk" ).contains("3")) {
			data.param
				.where(" union all																					")
				.where(" select  0 as line_stat																		")
				.where("       , null as invc_numb																	")
				.where("       , null as line_seqn																	")
				.where("       , max(a.cstm_idcd) as cstm_idcd														")
				.where("       , null as cstm_code																	")
				.where("       , case when a.acpt_dvcd = '1000' then concat( a.cstm_name ,' ', '월계 - ', substr(a.deli_date, 1, 4), '-', substr(a.deli_date, 5, 2))	")
				.where("              when a.acpt_dvcd = '2000' then concat( a.cstm_name ,' ', '월계 - ', substr(a.invc_date, 1, 4), '-', substr(a.invc_date, 5, 2))	")
				.where("         else concat( a.cstm_name ,' ', '월계 - ', substr(a.deli_date, 1, 4), '-', substr(a.deli_date, 5, 2))									")
				.where("         End as cstm_name																	")
				.where("       , null as deli_date																	")
				.where("       , null as invc_date																	")
				.where("       , null as drtr_name																	")
				.where("       , null as item_code																	")
				.where("       , null as item_name																	")
				.where("       , null as item_spec																	")
				.where("       , null as lott_numb																	")
				.where("       , null as wrhs_name																	")
				.where("       , sum(a.ostt_qntt) as ostt_qntt														")
				.where("       , 0 as sale_pric																		")
				.where("       , sum(a.sale_amnt) as sale_amnt														")
				.where("       , sum(a.vatx_amnt) as vatx_amnt														")
				.where("       , sum(a.ttsm_amnt) as ttsm_amnt														")
				.where("       , null as acpt_numb																	")
				.where("       , null as acpt_dvcd																	")
				.where("       , null as prod_trst_dvcd																")
				.where("       , null as user_memo																	")
//				.where("       , max(a.deli_date) as sort_date														")
				.where("       , concat(substr(a.deli_date, 1, 4), '99') as sort_date								")
				.where("       , 3 as rnum																			")
				.where("       , null as trns_type																	")
				.where(" from  cte a																				")
//				.where(" group by a.cstm_idcd , concat(substr(a.deli_date, 1, 6), '99')								")
				.where(" group by a.cstm_idcd , 																	")
				.where("          case when a.acpt_dvcd = '1000' then concat(substr(a.deli_date, 1, 6), '99')		")
				.where("               when a.acpt_dvcd = '2000' then concat(substr(a.invc_date, 1, 6), '99')		")
				.where("          else  a.deli_date																	")
				.where("          End																				")
			;
		}

		// 합계
		if(arg.getParamText("chk" ).contains("4")) {
			data.param
				.where(" union all																					")
				.where(" select  0 as line_stat																		")
				.where("       , null as invc_numb																	")
				.where("       , null as line_seqn																	")
				.where("       , max(a.cstm_idcd) as cstm_idcd														")
				.where("       , null as cstm_code																	")
				.where("       , null as cstm_name																	")
				.where("       , null as deli_date																	")
				.where("       , null as invc_date																	")
				.where("       , null as drtr_name																	")
				.where("       , null as item_code																	")
				.where("       , '합계' as item_name																	")
				.where("       , null as item_spec																	")
				.where("       , null as lott_numb																	")
				.where("       , null as wrhs_name																	")
				.where("       , sum(a.ostt_qntt) as ostt_qntt														")
				.where("       , 0 as sale_pric																		")
				.where("       , sum(a.sale_amnt) as sale_amnt														")
				.where("       , sum(a.vatx_amnt) as vatx_amnt														")
				.where("       , sum(a.ttsm_amnt) as ttsm_amnt														")
				.where("       , null as acpt_numb																	")
				.where("       , null as acpt_dvcd																	")
				.where("       , null as prod_trst_dvcd																")
				.where("       , null as user_memo																	")
				.where("      , '99999999' as sort_date																")
				.where("       , 4 as rnum																			")
				.where("       , null as trns_type																	")
				.where(" from cte a																					")
				.where(" group by '9999999'																			")
			;
		}

		//거래처별 합계
		if(arg.getParamText("chk" ).contains("1")) {
			data.param
				.where(" union all																					")
				.where(" select  0 as line_stat																		")
				.where("       , null as invc_numb																	")
				.where("       , null as line_seqn																	")
				.where("       , max(a.cstm_idcd) as cstm_idcd														")
				.where("       , null as cstm_code																	")
				.where("       , concat(a.cstm_name,' ','합계  ') as cstm_name											")
				.where("       , null as deli_date																	")
				.where("       , null as invc_date																	")
				.where("       , null as drtr_name																	")
				.where("       , null as item_code																	")
				.where("       , null as item_name																	")
				.where("       , null as item_spec																	")
				.where("       , null as lott_numb																	")
				.where("       , null as wrhs_name																	")
				.where("       , sum(a.ostt_qntt) as ostt_qntt														")
				.where("       , 0 as sale_pric																		")
				.where("       , sum(a.sale_amnt) as sale_amnt														")
				.where("       , sum(a.vatx_amnt) as vatx_amnt														")
				.where("       , sum(a.ttsm_amnt) as ttsm_amnt														")
				.where("       , null as acpt_numb																	")
				.where("       , null as acpt_dvcd																	")
				.where("       , null as prod_trst_dvcd																")
				.where("       , null as user_memo																	")
				.where("      , '88888888' as sort_date																")
				.where("       , 5 as rnum																			")
				.where("       , null as trns_type																	")
				.where(" from cte a																					")
				.where(" group by a.cstm_idcd, '88888888'															")
			;
		}

		data.param
			.where(" order by cstm_idcd, sort_date, rnum, invc_numb, line_seqn										")
			.where(") a																								")
		;
		return data.selectForMap();
	}

	public SqlResultMap getMaster4(HttpRequestArgument arg, int page, int rows, String sort) throws Exception {


	DataMessage data = arg.newStorage("POS");

		data.param // 조회
		.where("select ")
		.where("       case when t.cstm_idcd is null then null	")
		.where("            else case when t.ostt_type is not null then t.cstm_code ")
		.where("                      else null")
		.where("                 end ")
		.where("       end cstm_code")
		.where("     , case when t.cstm_idcd is null then null	")
		.where("            else case when t.ostt_type is not null then t.cstm_name ")
		.where("                      else null")
		.where("                 end ")
		.where("       end cstm_name")
		.where("     , case when t.cstm_idcd is null then 5	")
		.where("            else case when t.ostt_type is not null then t.ostt_type ")
		.where("                      else 4")
		.where("                 end ")
		.where("       end ostt_type")
		.where("	 , t.1_month					")
		.where("	 , t.2_month					")
		.where("	 , t.3_month					")
		.where("	 , t.4_month					")
		.where("	 , t.5_month					")
		.where("	 , t.6_month					")
		.where("	 , t.7_month						")
		.where("	 , t.8_month					")
		.where("	 , t.9_month					")
		.where("	 , t.10_month					")
		.where("	 , t.11_month					")
		.where("	 , t.12_month					")
		.where("	 , t.sum						")

		.where("  from (")
		.where("       select  a.cstm_idcd, a.ostt_type,  b.cstm_code , b.cstm_name")
		.where("	 , sum(a.1_month)	as 1_month					")
		.where("	 , sum(a.2_month)	as 2_month					")
		.where("	 , sum(a.3_month)	as 3_month					")
		.where("	 , sum(a.4_month)	as 4_month					")
		.where("	 , sum(a.5_month)	as 5_month					")
		.where("	 , sum(a.6_month)	as 6_month					")
		.where("	 , sum(a.7_month)	as 7_month					")
		.where("	 , sum(a.8_month)	as 8_month					")
		.where("	 , sum(a.9_month)	as 9_month					")
		.where("	 , sum(a.10_month)	as 10_month					")
		.where("	 , sum(a.11_month)	as 11_month					")
		.where("	 , sum(a.12_month)	as 12_month					")
		.where("	 , sum(a.sum) 		as sum						")
		.where("  from (											")
		.where("        select s.*, 1 as ostt_type")
		.where("         from (")
		.where("		select a.cstm_idcd															")
		.where("			 , sum(if(MONTH(b.deli_date) = 1,  b.ttsm_amnt, 0)) AS 1_month			")
		.where(" 			 , sum(if(MONTH(b.deli_date) = 2,  b.ttsm_amnt, 0)) AS 2_month			")
		.where("			 , sum(if(MONTH(b.deli_date) = 3,  b.ttsm_amnt, 0)) AS 3_month			")
		.where("			 , sum(if(MONTH(b.deli_date) = 4,  b.ttsm_amnt, 0)) AS 4_month			")
		.where("			 , sum(if(MONTH(b.deli_date) = 5,  b.ttsm_amnt, 0)) AS 5_month			")
		.where("			 , sum(if(MONTH(b.deli_date) = 6,  b.ttsm_amnt, 0)) AS 6_month			")
		.where("			 , sum(if(MONTH(b.deli_date) = 7,  b.ttsm_amnt, 0)) AS 7_month			")
		.where("			 , sum(if(MONTH(b.deli_date) = 8,  b.ttsm_amnt, 0)) AS 8_month			")
		.where("			 , sum(if(MONTH(b.deli_date) = 9,  b.ttsm_amnt, 0)) AS 9_month			")
		.where("			 , sum(if(MONTH(b.deli_date) = 10, b.ttsm_amnt, 0)) AS 10_month			")
		.where("			 , sum(if(MONTH(b.deli_date) = 11, b.ttsm_amnt, 0)) AS 11_month			")
		.where("			 , sum(if(MONTH(b.deli_date) = 12, b.ttsm_amnt, 0)) AS 12_month			")
		.where("			 , sum(b.ttsm_amnt) 								AS sum				")
		.where("      from sale_ostt_mast a                                                 		")
		.where("             left outer join sale_ostt_item b on b.invc_numb = a.invc_numb  		")
		.where("             left outer join acpt_mast c on c.invc_numb = b.acpt_numb       		")
		.where("    where 1 = 1                                                             		")
		.where("       and a.line_stat < 2                                                  		")
		.where("       and ((json_value(c.json_data, '$.prod_trst_dvcd') <> '2000') or (c.acpt_dvcd = '2000' and json_value(c.json_data, '$.prod_trst_dvcd') <> '3000')) ")
		.where("       and substr(b.deli_date, 1, 4) = :invc_date1" , arg.getParamText("invc_date")	 )
		.where("       and json_value(b.json_data, '$.trns_date') is null                          	")
		.where("    group by a.cstm_idcd                                                           	")
		.where("                                                                                   	")
		.where("   ) s")
		.where("  where 1 = 1")
		.where("  and s.sum is not null	"	)

		.where("    union all                                                                      	")
		.where("                                                                                   	")
		.where("        select s.*, 1 as ostt_type")
		.where("         from (")
		.where("   select a.cstm_idcd                                                              	")
		.where("          , sum(if(MONTH( json_value(b.json_data, '$.trns_date')) = 1,   b.ttsm_amnt, 0)) AS 1_month     ")
		.where("          , sum(if(MONTH( json_value(b.json_data, '$.trns_date')) = 2,   b.ttsm_amnt, 0)) AS 2_month     ")
		.where("          , sum(if(MONTH( json_value(b.json_data, '$.trns_date')) = 3,   b.ttsm_amnt, 0)) AS 3_month     ")
		.where("          , sum(if(MONTH( json_value(b.json_data, '$.trns_date')) = 4,   b.ttsm_amnt, 0)) AS 4_month     ")
		.where("          , sum(if(MONTH( json_value(b.json_data, '$.trns_date')) = 5,   b.ttsm_amnt, 0)) AS 5_month     ")
		.where("          , sum(if(MONTH( json_value(b.json_data, '$.trns_date')) = 6,   b.ttsm_amnt, 0)) AS 6_month     ")
		.where("          , sum(if(MONTH( json_value(b.json_data, '$.trns_date')) = 7,   b.ttsm_amnt, 0)) AS 7_month     ")
		.where("          , sum(if(MONTH( json_value(b.json_data, '$.trns_date')) = 8,   b.ttsm_amnt, 0)) AS 8_month     ")
		.where("          , sum(if(MONTH( json_value(b.json_data, '$.trns_date')) = 9,   b.ttsm_amnt, 0)) AS 9_month     ")
		.where("          , sum(if(MONTH( json_value(b.json_data, '$.trns_date')) = 10,  b.ttsm_amnt, 0)) AS 10_month    ")
		.where("          , sum(if(MONTH( json_value(b.json_data, '$.trns_date')) = 11,  b.ttsm_amnt, 0)) AS 11_month    ")
		.where("          , sum(if(MONTH( json_value(b.json_data, '$.trns_date')) = 12,  b.ttsm_amnt, 0)) AS 12_month    ")
		.where("          , sum(b.ttsm_amnt) 															  AS sum		 ")
		.where("      from sale_ostt_mast a                                                                              ")
		.where("             left outer join sale_ostt_item b on b.invc_numb = a.invc_numb                               ")
		.where("             left outer join acpt_mast c on c.invc_numb = b.acpt_numb                                    ")
		.where("    where 1 = 1                                                                                          ")
		.where("       and a.line_stat < 2                                                                               ")
		.where("       and ((json_value(c.json_data, '$.prod_trst_dvcd') <> '2000') or (c.acpt_dvcd = '2000' and json_value(c.json_data, '$.prod_trst_dvcd') <> '3000')) ")
		.where("       and substr(json_value(b.json_data, '$.trns_date') , 1, 4) = :invc_date2" , arg.getParamText("invc_date"))
		.where("       and json_value(b.json_data, '$.trns_date') is not null                                            ")
		.where("    group by a.cstm_idcd                                                                                 ")
		.where("                                                                                                         ")
		.where("   ) s")
		.where("  where 1 = 1")
		.where("  and s.sum is not null	"	)

		.where("    union all                                                                                            ")
		.where("                                                                                                         ")
		.where("        select s.*, 1 as ostt_type")
		.where("         from (")
		.where("   select a.cstm_idcd                                                                                    ")
		.where("        , sum(if(MONTH(a.invc_date) = 1,  b.ttsm_amnt, 0)) AS 1_month                                    ")
		.where("          , sum(if(MONTH(a.invc_date) = 2,  b.ttsm_amnt, 0)) AS 2_month                                  ")
		.where("          , sum(if(MONTH(a.invc_date) = 3,  b.ttsm_amnt, 0)) AS 3_month                                  ")
		.where("          , sum(if(MONTH(a.invc_date) = 4,  b.ttsm_amnt, 0)) AS 4_month                                  ")
		.where("          , sum(if(MONTH(a.invc_date) = 5,  b.ttsm_amnt, 0)) AS 5_month                                  ")
		.where("          , sum(if(MONTH(a.invc_date) = 6,  b.ttsm_amnt, 0)) AS 6_month                                  ")
		.where("          , sum(if(MONTH(a.invc_date) = 7,  b.ttsm_amnt, 0)) AS 7_month                                  ")
		.where("          , sum(if(MONTH(a.invc_date) = 8,  b.ttsm_amnt, 0)) AS 8_month                                  ")
		.where("          , sum(if(MONTH(a.invc_date) = 9,  b.ttsm_amnt, 0)) AS 9_month                                  ")
		.where("          , sum(if(MONTH(a.invc_date) = 10, b.ttsm_amnt, 0)) AS 10_month                                 ")
		.where("          , sum(if(MONTH(a.invc_date) = 11, b.ttsm_amnt, 0)) AS 11_month                                 ")
		.where("          , sum(if(MONTH(a.invc_date) = 12, b.ttsm_amnt, 0)) AS 12_month                                 ")
		.where("          , sum(b.ttsm_amnt) 								 AS sum                                      ")
		.where("     from sale_rett_mast a                                                                               ")
		.where("           left outer join sale_rett_item b on b.invc_numb = a.invc_numb                                 ")
		.where("             left outer join acpt_mast c  on c.invc_numb = b.acpt_numb                                   ")
		.where("    where 1 = 1                                                                                          ")
		.where("       and a.line_stat < 2                                                                               ")
		.where("       and ((json_value(c.json_data, '$.prod_trst_dvcd') <> '2000') or (c.acpt_dvcd = '2000' and json_value(c.json_data, '$.prod_trst_dvcd') <> '3000')) ")
		.where("       and substr(a.invc_date , 1, 4) =:invc_date3" , arg.getParamText("invc_date"))
		.where("   ) s")
		.where("  where 1 = 1")
		.where("  and s.sum is not null	"	)
		.where(") a                                                                                                       ")
		.where("  left outer join cstm_mast b on b.cstm_idcd = a.cstm_idcd                                                ")
		.where("where 1 = 1                                                                                               ")
		.where("group by a.cstm_idcd, a.ostt_type with rollup                                                             ")
		.where(") t")
		;

		if (page == 0 && rows == 0) {
			return data.selectForMap(sort);
		} else {
			return data.selectForMap(page, rows, (page==1),sort);
		}
	}
}